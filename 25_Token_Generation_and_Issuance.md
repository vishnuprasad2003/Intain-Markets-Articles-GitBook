# Token Generation & Issuance

## Overview

Token generation and issuance is the process of creating FT (Fungible Token) tokens for funding notices. These tokens represent the drawdown amounts and enable blockchain-based tracking and distribution to lenders.

## What are FT Tokens?

### Definition

FT Tokens are:
- Fungible tokens on the blockchain
- Represent drawdown amounts
- Allocated to borrowers initially
- Distributed to lenders
- Enable transparent tracking

### Purpose

Tokens enable:
- Blockchain tracking: Immutable record of drawdowns
- Lender distribution: Allocate amounts to lenders
- Transparency: Clear visibility of token flow
- Security: Blockchain-based security
- Audit trail: Complete transaction history

---

## Token Generation Process

### When Tokens Are Created

Trigger:
- Funding notice status is `'PENDING_TOKEN_GENERATION'` (validated in code)
- Facility agent calls `updateTokenDistribution` API (via `PATCH /cf/funding-notices/:fundingNoticeId/token-distribution`)
- Request body contains `tokenDistribution` array with lender allocations: `[{ lenderGroupId, lenderOrgId, lenderName, commitmentAmount, votingPercentage, tokensAllocated }, ...]`
- System validates: total commitment amount equals request amount, at least one lender, voting percentages valid (0-100), amounts are numbers
- FT tokens created for borrower via blockchain smart contract call (`createFTTokensForBorrower` function)
- Tokens created on blockchain with amount equal to `requestAmount` from funding notice
- Status changes to `'TOKEN_GENERATED'` in `cf_funding_notices` collection
- Borrowing base updated: `borrowingBase`, `availableCapacity`, `utilisationPercentage` recalculated and stored

### Generation Steps

**Process:**
1. Facility agent initiates token generation
2. System creates FT tokens for borrower
3. Token distribution array updated
4. Each lender initialized with pending status
5. Status changes to TOKEN_GENERATED

### What Gets Created

**For borrower:**
- FT tokens created on blockchain representing drawdown amount (equal to `requestAmount` from funding notice)
- Token IDs generated by blockchain smart contract for tracking
- Blockchain records: creation transaction hash stored, token contract address stored, token amount recorded
- Token ownership: Borrower initially owns all tokens (tokens allocated to borrower's wallet address)
- Token metadata: Linked to funding notice via `fundingNoticeId`, contains facility and request information

**For lenders:**
- Token distribution initialized
- Allocation amounts specified
- Individual lender status set to pending
- Ready for distribution

---

## Token Distribution

### Initial Distribution

**To borrower:**
- All tokens created for borrower initially
- Borrower owns tokens
- Borrower can approve transfer
- Tokens represent drawdown amount

### Lender Allocation

**Distribution setup:**
- Each lender's allocation specified
- Tokens allocated per lender commitment
- Distribution percentages calculated
- Individual lender amounts determined

### Token Allocation Details

**Per lender:**
- `tokensAllocated`: Number of tokens allocated
- Allocation based on lender commitment
- Proportional to facility participation
- Specified in token distribution array

---

## Token Lifecycle

### Creation Phase

**PENDING_TOKEN_GENERATION:**
- Funding notice created
- Tokens not yet created
- Waiting for generation
- Ready for token creation

### Generation Phase

**TOKEN_GENERATED:**
- Tokens created for borrower
- Token distribution initialized
- Borrower owns tokens
- Ready for transfer approval

### Approval Phase

**TOKEN_APPROVED:**
- Borrower approves token transfer
- Tokens can be transferred
- Lenders can see allocation
- Ready for lender participation

### Distribution Phase

**After approval:**
- Tokens distributed to lenders
- Each lender receives allocation
- Individual lender tracking
- Fund transfers confirmed

---

## Token Information

### Token Details

**What tokens contain:**
- Token ID (unique identifier)
- Amount (token value)
- Owner (current holder)
- Allocation (lender distribution)
- Timestamp (creation time)

### Token Tracking

**Blockchain records:**
- Creation transaction
- Transfer transactions
- Ownership changes
- Distribution records
- Complete audit trail

---

## Borrower Token Approval

### Approval Process

**What borrower does:**
1. Reviews token allocation (via `GET /cf/funding-notices/:fundingNoticeId`) - sees `tokenDistribution` array with lender allocations
2. Verifies amounts correct: checks `tokensAllocated` for each lender matches expected distribution
3. Approves token transfer privilege (via `POST /cf/funding-notices/:fundingNoticeId/approve-token-transfer`)
4. System validates: funding notice status is `'TOKEN_GENERATED'`, borrower is issuer (`issuerId` matches `req.userId`)
5. Database update: status changes to `'TOKEN_APPROVED'`, `statusHistory` and `actionHistory` updated
6. Enables lender visibility: lenders can now query funding notices with `status: 'TOKEN_APPROVED'` and see this notice
7. Status changes to TOKEN_APPROVED in `cf_funding_notices` collection

### Why Approval Needed

Purpose:
- Borrower confirms token allocation
- Enables token transfer capability
- Makes funding notice visible to lenders
- Proceeds with drawdown process

### After Approval

**What happens:**
- Funding notice status: TOKEN_APPROVED
- Funding notice visible to lenders
- Lenders can review and approve
- Token transfer enabled
- Drawdown can proceed

---

## Lender Token Receipt

### When Lenders Receive Tokens

**After borrower approval:**
- Funding notice visible to lenders
- Lenders can see token allocation
- Individual lender amounts shown
- Ready for lender approval

### Token Allocation View

**Lenders see:**
- Their allocated token amount
- Total drawdown amount
- Their participation percentage
- Token distribution details

### Token Confirmation

**Lender actions:**
- Review token allocation
- Approve or reject drawdown
- Confirm fund transfer
- Track token receipt

---

## Best Practices

### For Facility Agents

1. **Generate promptly**: Create tokens soon after funding request approval
2. **Verify allocation**: Ensure token distribution correct
3. **Complete setup**: Initialize all lender allocations
4. **Monitor status**: Track token generation progress

### For Borrowers

1. **Review allocation**: Verify token amounts correct
2. **Approve timely**: Enable lender visibility promptly
3. **Understand tokens**: Know what tokens represent
4. **Track distribution**: Monitor token flow

### For Lenders

1. **Review allocation**: Verify your token amount
2. **Understand tokens**: Know what they represent
3. **Track receipt**: Monitor token distribution
4. **Confirm transfers**: Complete fund transfer confirmations

---

## Common Scenarios

### Scenario 1: Standard Generation

1. Funding request approved → Funding notice created
2. Facility agent generates tokens → Tokens created
3. Borrower approves transfer → Status: TOKEN_APPROVED
4. Lenders see allocation → Review and approve
5. Tokens distributed → Fund transfers complete

### Scenario 2: Multiple Lenders

1. Tokens created → Allocation to multiple lenders
2. Each lender sees their portion → Individual allocation
3. Lenders approve individually → Per-lender decisions
4. Tokens distributed per approval → Individual distribution

---

## Troubleshooting

### "Tokens not generated"
- Check funding notice status
- Verify updateTokenDistribution was called
- Ensure status is PENDING_TOKEN_GENERATION
- Contact support if issue persists

### "Token allocation incorrect"
- Review token distribution array
- Verify lender commitments
- Check allocation calculations
- Contact facility agent if needed

### "Can't approve tokens"
- Check funding notice status
- Verify tokens are generated
- Ensure you're the borrower
- Check if already approved

---

## Key Takeaways

1. Blockchain-based: Tokens on blockchain for transparency
2. Automatic creation: Generated via API call
3. Borrower approval: Borrower must approve transfer
4. Lender distribution: Allocated to lenders per commitment
5. Complete tracking: Full audit trail on blockchain

Understanding token generation and issuance helps you understand how drawdowns are tracked and distributed through the blockchain-based token system.
